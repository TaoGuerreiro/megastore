#!/usr/bin/env ruby
# frozen_string_literal: true

# Script de configuration automatique pour les tests Instagram
# Usage: bin/setup_instagram_tests

require "optparse"
require "fileutils"

class InstagramTestSetup
  def initialize
    @options = {
      force: false,
      verbose: false,
      skip_python: false
    }
    parse_options
  end

  def run
    puts "ğŸ”§ Configuration de l'environnement de test Instagram..."
    puts "=" * 60

    results = {}

    # Configuration RSpec
    results[:rspec] = setup_rspec unless @options[:skip_python]

    # Configuration Python
    results[:python] = setup_python unless @options[:skip_python]

    # Configuration des scripts
    results[:scripts] = setup_scripts

    # RÃ©sumÃ© final
    print_summary(results)
  end

  private

  def parse_options
    OptionParser.new do |opts|
      opts.banner = "Usage: bin/setup_instagram_tests [options]"

      opts.on("--force", "Forcer la rÃ©installation") do
        @options[:force] = true
      end

      opts.on("--skip-python", "Ignorer la configuration Python") do
        @options[:skip_python] = true
      end

      opts.on("-v", "--verbose", "Mode verbeux") do
        @options[:verbose] = true
      end

      opts.on("-h", "--help", "Afficher cette aide") do
        puts opts
        exit
      end
    end.parse!
  end

  def setup_rspec
    puts "\nğŸ“‹ Configuration RSpec..."
    puts "-" * 30

    # VÃ©rifier que RSpec est installÃ©
    unless system("bundle exec rspec --version > /dev/null 2>&1")
      puts "âŒ RSpec n'est pas installÃ©. Installation..."
      system("bundle install")
    end

    # VÃ©rifier shoulda-matchers
    unless File.exist?("spec/rails_helper.rb") && File.read("spec/rails_helper.rb").include?("Shoulda::Matchers")
      puts "âŒ shoulda-matchers non configurÃ©. Configuration..."
      # La configuration a dÃ©jÃ  Ã©tÃ© faite prÃ©cÃ©demment
    end

    puts "âœ… Configuration RSpec OK"
    { success: true, type: "RSpec" }
  end

  def setup_python
    puts "\nğŸ Configuration Python..."
    puts "-" * 30

    python_dir = Rails.root.join("app/instagram_scripts")
    venv_path = python_dir.join("venv")
    requirements_path = python_dir.join("requirements.txt")

    # VÃ©rifier si l'environnement virtuel existe
    if venv_path.exist? && !@options[:force]
      puts "âœ… Environnement virtuel Python dÃ©jÃ  configurÃ©"
      return { success: true, type: "Python" }
    end

    # CrÃ©er l'environnement virtuel
    puts "ğŸ“¦ CrÃ©ation de l'environnement virtuel Python..."
    Dir.chdir(python_dir) do
      unless system("python3 -m venv venv")
        puts "âŒ Impossible de crÃ©er l'environnement virtuel"
        return { success: false, type: "Python", error: "Ã‰chec crÃ©ation venv" }
      end

      # Activer et installer les dÃ©pendances
      puts "ğŸ“¥ Installation des dÃ©pendances Python..."
      activate_cmd = "source venv/bin/activate && pip install --upgrade pip"
      install_cmd = "source venv/bin/activate && pip install -r requirements.txt"

      unless system(activate_cmd)
        puts "âŒ Impossible d'activer l'environnement virtuel"
        return { success: false, type: "Python", error: "Ã‰chec activation venv" }
      end

      unless system(install_cmd)
        puts "âŒ Impossible d'installer les dÃ©pendances"
        return { success: false, type: "Python", error: "Ã‰chec installation dÃ©pendances" }
      end

      # Rendre les scripts exÃ©cutables
      puts "ğŸ”§ Configuration des permissions..."
      system("chmod +x scripts/*.py")
      system("chmod +x test_python_scripts.py")
    end

    puts "âœ… Configuration Python OK"
    { success: true, type: "Python" }
  end

  def setup_scripts
    puts "\nğŸ”§ Configuration des scripts..."
    puts "-" * 30

    # Rendre le script de test unifiÃ© exÃ©cutable
    test_script = Rails.root.join("bin/test_instagram")
    if test_script.exist?
      system("chmod +x #{test_script}")
      puts "âœ… Script de test unifiÃ© configurÃ©"
    end

    # Rendre le script de setup exÃ©cutable
    setup_script = Rails.root.join("bin/setup_instagram_tests")
    if setup_script.exist?
      system("chmod +x #{setup_script}")
      puts "âœ… Script de setup configurÃ©"
    end

    puts "âœ… Configuration des scripts OK"
    { success: true, type: "Scripts" }
  end

  def print_summary(results)
    puts "\n" + "=" * 60
    puts "ğŸ“Š RÃ‰SUMÃ‰ DE LA CONFIGURATION"
    puts "=" * 60

    total_configs = results.size
    successful_configs = results.values.count { |r| r[:success] }
    failed_configs = total_configs - successful_configs

    results.each do |type, result|
      status = result[:success] ? "âœ…" : "âŒ"
      error_msg = result[:error] ? " (#{result[:error]})" : ""
      puts "#{status} #{result[:type]}#{error_msg}"
    end

    puts "\nğŸ“ˆ Statistiques:"
    puts "   Total: #{total_configs}"
    puts "   RÃ©ussis: #{successful_configs}"
    puts "   Ã‰chouÃ©s: #{failed_configs}"

    if failed_configs > 0
      puts "\nâŒ Certaines configurations ont Ã©chouÃ©!"
      puts "\nğŸ’¡ Conseils:"
      puts "   - VÃ©rifiez que Python 3 est installÃ©"
      puts "   - VÃ©rifiez que bundle est installÃ©"
      puts "   - Utilisez --force pour forcer la rÃ©installation"
      exit 1
    else
      puts "\nâœ… Configuration terminÃ©e avec succÃ¨s!"
      puts "\nğŸš€ Vous pouvez maintenant utiliser:"
      puts "   bin/test_instagram --help"
    end
  end
end

# Point d'entrÃ©e
if __FILE__ == $PROGRAM_NAME
  # Charger l'environnement Rails
  require_relative "../config/environment"

  setup = InstagramTestSetup.new
  setup.run
end
